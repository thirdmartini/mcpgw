<!DOCTYPE html>
<html lang="en" style="background: black; height: 100dvh; width: 100dvw; overflow: clip;">

<head>
    <meta charset="utf-8">
    <title>Agentic Samantha</title>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/handlebars.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/default.css">
</head>

<body>
<div class="main backdrop">
    <header class="header-widget">
        <div class="counter">3</div>
        <h1 class="title">Samantha</h1>
        <div class="header-icon-group">
            <button class="header-icon-btn" title="History">📋</button>
            <button class="header-icon-btn" title="New Chat" onclick="newConversation();"> 🗑️</button>
        </div>
    </header>

    <div id="history" class="history">
    </div>

    <div class="query-container">
        <div class="search-widget">
            <input id="chat-input" type="textarea" wrap="soft" placeholder="Ask anything" class="search-input" onchange="chatRequestClicked();">
            <div class="button-group">
                <button class="action-btn" onclick="newConversation();">New Chat</button>
                <!-- <button class="icon-btn">📎</button> -->

                <button id="mic" class="icon-btn" style="position: absolute;right: 50px" onclick="toggleRecording();">🎙️</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import * as Audio from "/static/js/recorder.js";

    const containers = ['webm', 'ogg', 'mp4', 'x-matroska', '3gpp', '3gpp2',
        '3gp2', 'quicktime', 'mpeg', 'aac', 'flac', 'wav']
    const codecs = ['vp9', 'vp8', 'avc1', 'av1', 'h265', 'h.265', 'h264',
        'h.264', 'opus', 'pcm', 'aac', 'mpeg', 'mp4a'];

    const supportedAudios = containers.map(format => `audio/${format}`)
        .filter(mimeType => MediaRecorder.isTypeSupported(mimeType))
    const supportedAudioCodecs = supportedAudios.flatMap(audio =>
        codecs.map(codec => `${audio};codecs=${codec}`))
        .filter(mimeType => MediaRecorder.isTypeSupported(mimeType))

    console.log('Supported Audio formats:', supportedAudios)
    console.log('Supported Audio codecs:', supportedAudioCodecs)

    const supportedVideos = containers.map(format => `video/${format}`)
        .filter(mimeType => MediaRecorder.isTypeSupported(mimeType))
    const supportedVideoCodecs = supportedVideos.flatMap(video =>
        codecs.map(codec => `${video};codecs=${codec}`))
        .filter(mimeType => MediaRecorder.isTypeSupported(mimeType))

    console.log('Supported Video formats:', supportedVideos)
    console.log('Supported Video codecs:', supportedVideoCodecs)


    /* Templates need to load first */
    let viewTemplate = null
    App.GetTemplate("/static/templates/view.html", function (data) {
        viewTemplate = Handlebars.compile(data);
        initApplication()

        /*
        appendRequest("Hello, how can I help you today?")
        appendResponse("I'm doing well yourself?", null)
        appendRequest("I'm just here for a chat, anything you want to talk about?")
        appendThinking("Thinking...")
        appendResponse("Anything really!", null, true)
        appendRequest("Hello, how can I help you today?")
        appendResponse("I'm doing well yourself?", null)
        appendRequest("I'm just here for a chat, anything you want to talk about? ")
        appendResponse("I'm doing well yourself?", null)*/
    })



    /*
    let debug = document.getElementById("debug")
    debug.innerHTML = supportedAudios + " | " + supportedAudioCodecs

    let mode = document.getElementById("mode")
*/

    let recorder = Audio.NewRecorder()
    let isRecording = false

    const options = {
        audioBitsPerSecond: 16000,
        mimeType: "audio/mp4",
    };

    function uuidv4() {
        return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        );
    }

    let chatId = uuidv4()

    var dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

    function createElementFromHTML(htmlString) {
        let div = document.createElement('div');
        div.innerHTML = htmlString.trim();
        return div.firstChild;
    }

    function chatRequest(prompt) {
        appendRequest(prompt)
        appendThinking("Thinking..")

        fetch('/api/v.1/chat', {
            method: 'POST',
            timeout: 1500, 
            headers: {
                "X-Conversation-Id": chatId,
            },
            body: JSON.stringify({
                "Prompt": prompt,
            })
        })
        .then(response => response.json())
        .then(data => {
            appendResponse(data.Message, data.Images, true, data.Metrics)
            if (data.Audio != null) {
                playAudio(data.Audio)
            }
        })
    }

    function initApplication() {
        fetch('/api/v.1/tools', {
            method: 'GET',
            headers: {
                "X-Conversation-Id": chatId,
            },
        })
        .then(response => response.json())
        .then(data => {
            let introMessages = new Array()
            introMessages.push("Hi, I'm Samantha, a simple Agentic AI.\n")
            introMessages.push("You can ask me questions about anything, and I can also perform task with the tools provided to me.\n")

            introMessages.push("Here are some tools I can use:\n")

            for (let i = 0; i < data.length; i++) {
                let tool = data[i]

                console.log(tool)

                introMessages.push(tool.name)
                introMessages.push("   " + tool.description)
            }
            appendResponse( introMessages.join("\n"), null, true)

        })
        .catch(error => {
            console.log('Error uploading audio:', error);
        });
    }


    let appendRequest = function(text) {
        let history = document.getElementById("history")

        let content = viewTemplate({
            icon: "user.png",
            username: "You",
            postedtime: (new Date()).toLocaleDateString("en-US", dateOptions),
            content: text,
        })
        history.appendChild(createElementFromHTML(content))
        history.scrollTop = history.scrollHeight; // scroll to bottom
    }

    let appendThinking = function(text, images) {
        let history = document.getElementById("history")
        let post = {
            icon: "samantha.png",
            username: "Samantha (Agentic)",
            postedtime: (new Date()).toLocaleDateString("en-US", dateOptions),
            content: "Thinking...",
        }
        history.appendChild(createElementFromHTML(viewTemplate(post)))
        history.scrollTop = history.scrollHeight;
    }

    let appendResponse = function(text, images, removeThinking, metrics) {
        let history = document.getElementById("history")

        if (removeThinking == true) {
            history.lastChild.remove()
        }

        let post = {
            icon: "samantha.png",
            username: "Samantha (Agentic)",
            postedtime: (new Date()).toLocaleDateString("en-US", dateOptions),
            content: text,
        }

        if (metrics != null) {
            post.outputrate = metrics.OutputTokenRate.toFixed(3)
            post.evaltime = metrics.RequestTime.toFixed(3)
            post.audiotime = metrics.AudioEncodeTime.toFixed(3)
        }

        if (images != null ) {
            images.forEach(function (item, index){
                post.image = "data:image/jpeg;base64,"+item

            })
        }
        history.appendChild(createElementFromHTML(viewTemplate(post)))
        history.scrollTop = history.scrollHeight;
    }

    const getAudioContext =  () => {
        AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContent = new AudioContext();
        return audioContent;
    };

    function base64ToArrayBuffer(base64) {
        var binaryString = atob(base64);
        var bytes = new Uint8Array(binaryString.length);
        for (var i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    let playAudio = async function(rawWav) {
        const audioContext = getAudioContext();
        const audioBuffer = await audioContext.decodeAudioData(base64ToArrayBuffer(rawWav));

        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);

// play audio
        source.start();
        //Audio.PlayOnce(atob(rawWav))
    }

    window.newConversation = function() {
        chatId = uuidv4()
        console.log("new chat id:", chatId)
        let history = document.getElementById("history")
        history.innerHTML = ""
        appendResponse("What do you need help with today?", null, false)
    }

    window.chatRequestClicked = function() {
        let input = document.getElementById("chat-input")
        let text = input.value
        input.value = ""
        chatRequest(text)
    }


    window.toggleRecording = function() {
        let button = document.getElementById("mic");
        isRecording = !isRecording

        if (isRecording == true) {
            button.style.background = "#ffff00"

            recorder.Start(function() {
                console.log("captured")
            }, options).then(() => { //on success
                button.style.background = "#ff0000"
            }).catch(error => {
                debug.innerHTML = error
            })

        } else {
            button.style.background = "#5555ff"

            recorder.Stop()
                .then(audioAsblob => {
                    console.log("recording captured", audioAsblob)
                    //Audio.Play("player", audioAsblob)

                    // send the audio to the server
                    fetch('/api/v.1/recordings/transcribe', {
                        method: 'POST',
                        headers: {
                          "X-Conversation-Id": chatId,
                        },
                        body: audioAsblob
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Audio uploaded successfully:', data);
                        console.log("REQUEST OK:", data);

                        button.style.background = "#3a3a3a"
                        chatRequest(data.Prompt)
                    })
                    .catch(error => {
                        console.log('Error uploading audio:', error);
                    });
                })
                .catch(error => {
                    //Error handling structure

                    switch (error.name) {
                        case 'InvalidStateError': //error from the MediaRecorder.stop
                            console.log("An InvalidStateError has occurred.");
                            break;
                        default:
                            console.log("An error occurred with the error name " + error.name);
                    };
                });
        }
    }
</script>
</body>
</html>